# 互動功能詳細說明

## 功能概述

系統提供完整的雙向互動功能，讓您能夠在價格圖表、成交明細和五檔報價之間無縫切換，即時查看任意時間點的市場狀況。

## 三大互動模式

### 1️⃣ 點擊價格圖表 → 查看成交明細 + 五檔

**操作方式：**
- 在價格走勢圖上點擊任意位置

**效果：**
- ✅ 成交明細自動滾動到對應時間
- ✅ 該筆交易行以藍色高亮顯示
- ✅ 五檔報價更新為該時間點的五檔狀態
- ✅ 五檔標題顯示對應的時間戳（藍色字體）
- ✅ 高亮效果持續 3 秒後消失

**使用情境：**
- 發現價格突然上漲，想知道那個時間點的成交和五檔狀況
- 查看某個價格位置的市場深度
- 追蹤價格變動的細節

---

### 2️⃣ 點擊成交明細 → 在圖表標示位置

**操作方式：**
- 在成交明細列表中點擊任意一行

**效果：**
- ✅ 價格圖表上顯示紅色高亮點
- ✅ 清楚標示該筆交易在圖表上的位置
- ✅ 五檔報價更新為該時間點的狀態
- ✅ 紅色高亮點持續 3 秒後消失

**使用情境：**
- 在明細中看到大額交易，想知道對價格的影響
- 確認某筆交易在走勢圖上的位置
- 查看交易前後的價格變化

---

### 3️⃣ 滾動成交明細 → 五檔即時跟隨

**操作方式：**
- 用滑鼠滾輪或拖曳滾動條瀏覽成交明細

**效果：**
- ✅ 五檔報價即時更新為可見區域中心的時間點
- ✅ 五檔標題顯示當前時間戳（藍色字體）
- ✅ 平滑流暢，無延遲感

**技術特點：**
- 智能防抖動（100ms）減少不必要的更新
- 自動計算可見區域的中心位置
- 尋找最接近的五檔資料（誤差 < 1秒）

**使用情境：**
- 瀏覽一段時間內的交易歷史
- 觀察五檔變化如何影響成交
- 追蹤大單進出對五檔的影響

---

## 視覺提示

### 顏色說明
| 元素 | 顏色 | 說明 |
|-----|------|------|
| 高亮交易行 | 藍色漸變 | #0066cc → #004488 |
| 圖表高亮點 | 紅色 | #ff0000 |
| 五檔時間戳 | 亮藍色 | #0099ff |
| 價格顯示 | 黃色 | #ffcc00 |
| 買盤 | 粉紅色 | 背景色 |
| 賣盤 | 黑色 | 背景色 |

### 游標變化
- 懸停在價格圖表上：**手指游標** 👆 表示可點擊
- 懸停在成交明細上：**手指游標** 👆 表示可點擊
- 滾動成交明細時：五檔標題會顯示 `@ HH:MM:SS.d`

---

## 資料同步機制

### 時間對齊演算法
系統使用智能時間匹配算法，確保資料準確對應：

```
1. 獲取目標時間戳
2. 在五檔歷史中尋找最接近的記錄
3. 計算時間差異
4. 選擇誤差最小的五檔資料（通常 < 1秒）
5. 更新顯示
```

### 索引轉換
- **圖表資料**：按時間正序排列（最早 → 最晚）
- **成交明細**：按時間倒序排列（最新 → 最早）
- 系統自動處理索引轉換，確保資料對應正確

---

## 效能優化

### 1. 防抖動機制
- 滾動事件延遲 100ms 執行
- 避免頻繁更新造成卡頓
- 提升使用者體驗

### 2. 智能快取
- 完整五檔歷史載入一次
- 後續查詢直接從記憶體讀取
- 無需重複請求伺服器

### 3. 條件渲染
- 只在資料變化時更新 DOM
- 避免不必要的重繪
- 保持介面流暢

---

## 使用技巧

### 💡 快速查看特定時間的市場狀況
1. 在價格圖表上點擊目標時間點
2. 查看該時間的成交明細和五檔
3. 向上或向下滾動明細查看前後變化

### 💡 追蹤大單影響
1. 在成交明細中找到大額交易（數量大）
2. 點擊該行，查看在圖表上的位置
3. 觀察五檔變化（內盤量/外盤量）

### 💡 觀察五檔變化趨勢
1. 慢速滾動成交明細
2. 觀察五檔買賣力道變化
3. 找出支撐/壓力位置

### 💡 比對多個時間點
1. 點擊第一個時間點，記住五檔狀況
2. 點擊第二個時間點，比較差異
3. 分析市場變化原因

---

## 常見問題

### Q: 為什麼有時五檔更新會有延遲？
A: 系統使用 100ms 防抖動機制，這是為了避免滾動時過於頻繁的更新。實際使用中幾乎感覺不到延遲。

### Q: 五檔時間和成交時間可能不完全一致？
A: 是的，系統會尋找最接近的五檔資料。通常誤差小於 1 秒，這是因為五檔更新頻率可能與成交不同步。

### Q: 滾動成交明細時，圖表會更新嗎？
A: 不會。為了避免干擾，滾動時只更新五檔，不在圖表上顯示紅點。只有點擊成交明細時才會在圖表顯示紅點。

### Q: 可以關閉自動更新嗎？
A: 目前版本不支援。如果需要固定查看某個時間點的五檔，可以點擊該時間點後停止滾動。

### Q: 高亮效果可以調整持續時間嗎？
A: 目前固定為 3 秒。如需修改，可以在 `chart.js` 中搜尋 `3000` 並修改數值（單位：毫秒）。

---

## 鍵盤快捷鍵（未來功能）

計畫中的快捷鍵：
- `↑` / `↓` - 瀏覽成交明細
- `Space` - 暫停/恢復五檔自動更新
- `Esc` - 清除所有高亮效果
- `1-5` - 快速跳到時間區段

---

## 技術實作細節

### 核心函數
- `onTradesScroll()` - 滾動事件處理
- `updateDepthByVisibleTrade()` - 根據可見交易更新五檔
- `updateDepthByTradeIndex()` - 根據索引更新五檔
- `findClosestDepthByTimestamp()` - 尋找最接近的五檔
- `updateDepthDisplay()` - 更新五檔顯示

### 全域變數
- `allTradesData` - 完整成交明細
- `allDepthHistory` - 完整五檔歷史
- `isUserScrolling` - 滾動狀態標記
- `scrollTimeout` - 防抖動計時器

---

## 更新日誌

**v2.0 - 進階互動功能**
- ✅ 新增滾動成交明細時五檔即時跟隨
- ✅ 新增五檔時間戳顯示
- ✅ 優化點擊圖表時同步更新五檔
- ✅ 改進索引轉換邏輯
- ✅ 添加智能防抖動機制

**v1.0 - 基礎互動功能**
- ✅ 點擊圖表查看成交明細
- ✅ 點擊明細顯示圖表位置
- ✅ 高亮動畫效果

---

如有其他問題或建議，歡迎回饋！
