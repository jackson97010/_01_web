# 更新日誌

## 最新更新 - 互動功能增強

### 新增功能

#### 1. 價格圖表點擊互動
- ✅ 點擊價格走勢圖上的任意位置
- ✅ 自動滾動到對應時間的成交明細
- ✅ 成交明細行會以藍色高亮顯示
- ✅ 高亮效果會有漸變動畫，持續 3 秒後自動消失

#### 2. 成交明細反向互動
- ✅ 點擊成交明細列表中的任意一行
- ✅ 在價格圖表上顯示紅色高亮點
- ✅ 清楚標示該筆交易在圖表上的位置
- ✅ 高亮點會持續 3 秒後自動消失

#### 3. 視覺改進
- ✅ 添加使用提示：「💡 點擊圖表查看對應時間的成交明細」
- ✅ 成交明細行支援 hover 效果
- ✅ 價格顯示為黃色（#ffcc00）更醒目
- ✅ 高亮動畫效果更流暢

#### 4. 時間格式優化
- ✅ 時間顯示格式為 HH:MM:SS.mmm（顯示到毫秒，小數點後三位）
- ✅ 更精確顯示每筆 tick 的時間
- ✅ 適合高頻交易資料分析

### 技術實作

#### 修改的檔案
1. **static/js/chart.js**
   - 添加 `onClick` 事件處理器到價格圖表
   - 添加 `onHover` 事件改變滑鼠游標
   - 新增 `scrollToTradeByIndex()` 函數
   - 新增 `highlightChartPoint()` 函數
   - 優化 `formatTime()` 函數
   - 添加 `allTradesData` 全域變數保存完整交易資料

2. **static/css/style.css**
   - 添加 `.highlight-row` 樣式
   - 添加 `@keyframes highlightFade` 動畫
   - 添加 `.trades-table tr:hover` 效果
   - 添加 `.chart-header` 和 `.chart-hint` 樣式
   - 優化 `.trade-price` 樣式

3. **templates/viewer.html**
   - 添加圖表提示區塊
   - 添加鍵盤快捷鍵提示
   - 改進視覺層次結構

4. **static/css/style.css（響應式設計）**
   - 添加多個媒體查詢斷點（1920px+, 1600px, 1400px, 1200px, 768px, 480px）
   - 添加高度媒體查詢（768px, 600px）
   - 動態調整佈局方向（橫向/縱向）
   - 優化各種螢幕尺寸的字體大小和間距
   - 使用 viewport 單位（vh）調整圖表高度

5. **run_batch.bat & run_viewer.bat**
   - 修正編碼問題（添加 `chcp 65001`）
   - 改為英文訊息避免亂碼

### 使用方式

#### 圖表到明細
1. 在價格走勢圖上找到感興趣的價格點
2. 用滑鼠點擊該位置（滑鼠游標會變成手指）
3. 右側成交明細會自動滾動並高亮對應的交易

#### 明細到圖表
1. 在成交明細列表中找到感興趣的交易
2. 點擊該行
3. 左側價格圖表會顯示紅色高亮點標示位置

### 視覺效果

- **成交明細高亮**：藍色漸變背景（#0066cc → #004488）
- **圖表高亮點**：紅色圓點（半徑 8px）
- **價格顯示**：黃色粗體（#ffcc00）
- **動畫時長**：3 秒

### 相容性

- ✅ Chrome 90+
- ✅ Firefox 88+
- ✅ Edge 90+
- ✅ Safari 14+

### 已知問題

無

#### 5. 鍵盤快捷鍵 ⌨️
- ✅ **上鍵 ↑**：瀏覽較新的交易（向前）
- ✅ **下鍵 ↓**：瀏覽較舊的交易（向後）
- ✅ **空白鍵**：播放/暫停自動回放
- ✅ 自動停止播放當使用鍵盤瀏覽時
- ✅ 在輸入框內時不觸發快捷鍵
- ✅ **已確認運作正常**（實作位置：static/js/chart.js:184-230）

#### 6. 走勢圖與回放邏輯
- ✅ **顯示所有 tick 資料**：包含 09:00 到 13:30 的所有成交明細（不限筆數）
- ✅ **分鐘內跳動變化**：roll 時可以看到每分鐘內的所有 tick 價格變化
- ✅ **回放範圍**：從 09:00 開始 roll 到 13:30
- ✅ **完整 tick 顯示**：走勢圖顯示每一筆成交的價格變化
- ✅ **時間軸初始化**：自動定位到 09:00 第一筆交易
- ✅ **成交明細初始化**：自動滾動到最底部（09:00 位置）
- ✅ **資料完整性**：後端返回所有交易資料，移除 50 筆限制
- ✅ **播放功能修正**：播放方向從 09:00 往 13:30（索引遞減，符合倒序資料結構）
- ✅ **時間格式精確度**：顯示到毫秒（HH:MM:SS.mmm）
- ✅ **當前位置紅點標記**：播放時在價格走勢圖上顯示紅色圓點標示當前播放位置

#### 7. VWAP 線（成交量加權平均價）
- ✅ 只在 09:00 以後計算並顯示 VWAP
- ✅ 公式：VWAP = Σ(價格 × 成交量) / Σ(成交量)
- ✅ **針對每一筆 tick 計算**：即時累積 VWAP
- ✅ 綠色虛線顯示（#00ff00）
- ✅ 盤前時段（08:30-08:59）完全不顯示 VWAP
- ✅ 即時計算，隨著每筆交易更新

#### 8. 均價計算（動態成交量加權平均價）
- ✅ **定義**：開盤到當前時間為止的平均成交價
- ✅ **計算方式**：累加開盤後到當前每筆成交的價格乘上數量，除以累計的成交數量
- ✅ **公式**：均價 = Σ(價格 × 數量) / Σ(數量)
- ✅ **動態更新**：回放時，均價會隨著當前時間點動態更新
- ✅ **每筆 tick 計算**：每移動到新的交易點，均價會即時重新計算
- ✅ **只計算正式交易時段**：09:00 以後的資料
- ✅ **與 VWAP 的關係**：均價使用當前時間點的 VWAP 值
- ✅ **顯示位置**：頂部股票資訊區的「均價」欄位

#### 9. 圖表 X 軸時間刻度優化
- ✅ **從 category 改為 time 類型**：X 軸使用真實的時間軸
- ✅ **固定時間刻度**：時間刻度按固定間隔顯示（每 1 分鐘）
- ✅ **時間範圍**：顯示 09:00~13:30 的完整交易時段
- ✅ **資料格式改為 {x, y}**：使用 Chart.js 的時間點格式
- ✅ **添加時間適配器**：引入 chartjs-adapter-date-fns 處理時間顯示
- ✅ **刻度標籤格式**：HH:mm 格式，清晰易讀
- ✅ **自動刻度分佈**：時間刻度均勻分佈，不受資料密度影響

#### 10. 圖表滾動功能增強
- ✅ 播放時圖表自動跟隨滾動
- ✅ 當前時間點保持在圖表視窗中間
- ✅ 圖表時間軸滑桿同步更新
- ✅ 修復點擊縮放後的圖表跳轉問題

#### 11. 成交明細獨立滾動
- ✅ 成交明細區域有獨立滾動條
- ✅ 滾動時不影響整個頁面
- ✅ 優化 flexbox 佈局

#### 12. 五檔報價時間戳顯示
- ✅ 顯示五檔報價的時間（藍色字體）
- ✅ 格式：@ HH:MM:SS.d
- ✅ 跟隨成交明細滾動即時更新
- ✅ 回放時自動更新五檔報價（使用五檔歷史資料）
- ❌ **移除掛單變化歷史區塊**：不再顯示底部的掛單變化歷史列表

#### 13. 拖曳選取時間範圍
- ✅ **按住 Shift + 拖曳滑鼠**：選取時間範圍
- ✅ 自動縮放到選取的時間區間
- ✅ 十字游標提示（Shift 鍵）
- ✅ 自動調整圖表窗口和時間軸滑桿
- ✅ 最小選取範圍限制（10% 的資料）

### 使用說明

#### 鍵盤快捷鍵
- **↑ 上鍵**：查看較新的交易
- **↓ 下鍵**：查看較舊的交易
- **空白鍵**：播放/暫停

#### 圖表互動
- **點擊圖表**：跳轉到對應的成交明細
- **Shift + 拖曳**：選取時間範圍並縮放
- **放大/縮小按鈕**：調整圖表視窗大小
- **重置按鈕**：恢復完整視圖

#### 14. 響應式設計（Responsive Design）
- ✅ 根據螢幕尺寸動態調整佈局
- ✅ **1920px+**：大螢幕優化，側邊欄寬度 450px
- ✅ **1600px 以下**：中等螢幕，側邊欄縮小至 350px
- ✅ **1400px 以下**：進一步縮小至 320px
- ✅ **1200px 以下**：平板模式，切換為垂直佈局，五檔與成交明細並排
- ✅ **768px 以下**：手機優化，五檔與成交明細改為上下排列
- ✅ **480px 以下**：小螢幕手機，字體縮小，間距緊湊
- ✅ **低高度螢幕**：自動調整圖表高度，優化垂直空間使用

### 未來改進計畫

- [ ] 支援多股票對比顯示
- [ ] 添加技術指標（MA, RSI 等）
- [ ] 添加成交量分布圖
- [ ] 支援匯出選取範圍的資料

---

## 初始版本

### 核心功能
- 批次處理 OTC/TSE Quote 資料
- 智慧過濾（只保存漲停相關股票）
- 網頁視覺化介面
- 價格走勢圖
- 成交量圖
- 五檔報價
- 成交明細
- 掛單歷史
